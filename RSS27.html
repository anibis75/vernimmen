<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Veille sectorielle ‚Äî Tereos M&A</title>
  <meta name="description" content="Lecteur RSS multi-cat√©gories pour la veille sectorielle Tereos" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#0b0f14; --bg2:#101626; --fg:#eef3f9; --muted:#9fb0c5;
      --accent:#e63946; --accent2:#2ec4b6; --glass:rgba(255,255,255,.06);
      --glass-border:rgba(255,255,255,.15); --radius:24px; --shadow:0 14px 48px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,"Helvetica Neue",sans-serif; color:var(--fg);
      background:linear-gradient(135deg,var(--bg1),var(--bg2)); background-attachment:fixed;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* Animated background blobs */
    .bg-blob{position:fixed; inset:-20vmax; filter:blur(80px); opacity:.55; z-index:-2;
      background:radial-gradient(35vmax 35vmax at 20% 30%, rgba(230,57,70,.35), transparent 70%),
                 radial-gradient(40vmax 40vmax at 80% 20%, rgba(46,196,182,.35), transparent 70%),
                 radial-gradient(45vmax 45vmax at 50% 80%, rgba(67,97,238,.25), transparent 70%);
      animation:float 18s ease-in-out infinite alternate;
    }
    @keyframes float{to{transform:translate3d(0,-3vmax,0) scale(1.02)}}

    header{position:sticky; top:0; z-index:10; backdrop-filter: blur(10px);
      background:linear-gradient(180deg, rgba(0,0,0,.38), rgba(0,0,0,.14));
      border-bottom:1px solid var(--glass-border);
    }
    .head-inner{max-width:1200px; margin:0 auto; display:flex; align-items:center; gap:14px; padding:16px 22px;}
    .brand{display:flex; align-items:center; gap:12px; text-decoration:none; color:inherit;}
    .brand img{height:42px; width:auto; filter:drop-shadow(0 8px 16px rgba(0,0,0,.2));}
    .brand h1{margin:0; font-size: clamp(20px, 2.4vw, 28px); font-weight:800; letter-spacing:.25px;}
    .actions{margin-left:auto; display:flex; gap:10px}
    .icon-btn{border:1px solid var(--glass-border); background:var(--glass); color:var(--fg); border-radius:14px; padding:10px 12px; cursor:pointer; transition:transform .12s ease, box-shadow .2s ease;}
    .icon-btn:hover{transform:translateY(-1px); box-shadow:0 8px 24px rgba(0,0,0,.35)}

    /* Tabs */
    nav{max-width:1200px; margin:16px auto 0; padding:0 22px 8px;}
    .tabs{display:flex; gap:10px; flex-wrap:wrap}
    .tab{border:1px solid var(--glass-border); background:var(--glass); color:var(--fg); padding:10px 14px; border-radius:999px; font-weight:700; cursor:pointer; transition:background .2s ease;}
    .tab.active{background:linear-gradient(135deg, rgba(230,57,70,.25), rgba(46,196,182,.20));}

    main{max-width:1200px; margin:20px auto 60px; padding:0 22px;}

    /* Carousel */
    .carousel{position:relative; overflow:hidden; border-radius:var(--radius); margin-bottom:26px; background:linear-gradient(145deg, rgba(255,255,255,.08), rgba(255,255,255,.02)); border:1px solid var(--glass-border); box-shadow:var(--shadow);}
    .track{display:flex; transition:transform .5s ease-in-out}
    .slide{min-width:100%; padding:36px 24px; text-align:center}
    .slide h2{margin:0 0 10px; font-weight:800; font-size: clamp(20px,2.2vw,26px)}
    /* Liens carrousel : gras sans soulign√© */
    .slide h2 a{color:var(--fg); text-decoration:none; font-weight:800}
    .slide time{display:block; color:var(--muted); font-size:14px; margin-top:4px}
    .slide .cat{margin-top:10px; display:inline-block; padding:6px 12px; border-radius:999px; border:1px solid var(--glass-border); background:var(--glass); font-weight:600}
    .cbtn{position:absolute; top:50%; transform:translateY(-50%); border:none; background:rgba(0,0,0,.35); color:#fff; padding:10px 12px; border-radius:12px; cursor:pointer}
    .cbtn.prev{left:8px} .cbtn.next{right:8px}

    /* Feed cards */
    .feed{margin-top:18px}
    .card{background:linear-gradient(145deg, rgba(255,255,255,.08), rgba(255,255,255,.02)); border:1px solid var(--glass-border); border-radius:var(--radius); padding:20px; margin:16px 0; box-shadow:var(--shadow); transition:transform .2s ease, box-shadow .2s ease;}
    .card:hover{transform:translateY(-2px); box-shadow:0 12px 32px rgba(0,0,0,.45)}
    .card h3{margin:0 0 6px; font-size: clamp(17px, 2vw, 21px); font-weight:800}
    /* Liens liste : gras + soulign√© */
    .card h3 a{color:var(--fg); text-decoration:underline; font-weight:800}
    .meta{display:flex; gap:12px; align-items:center; color:var(--muted); font-size:13px}

    /* Configurator modal */
    .modal{position:fixed; inset:0; display:none; place-items:center; z-index:50;}
    .modal.open{display:grid}
    .scrim{position:absolute; inset:0; background:rgba(0,0,0,.55); backdrop-filter: blur(2px)}
    .panel{position:relative; width:min(920px,92vw); max-height:86vh; overflow:auto; border-radius:24px; padding:20px;
      background:linear-gradient(145deg, rgba(255,255,255,.1), rgba(255,255,255,.03)); border:1px solid var(--glass-border); box-shadow:var(--shadow)}
    .panel h2{margin:0 0 12px}
    .cblock{border:1px dashed var(--glass-border); border-radius:16px; padding:12px; margin:10px 0; background:rgba(255,255,255,.03)}
    .cblock .row{display:flex; gap:8px; align-items:center; margin-bottom:8px}
    .input, .chip{background:rgba(255,255,255,.08); border:1px solid var(--glass-border); color:var(--fg); border-radius:12px; padding:10px 12px}
    .input{flex:1}
    .chip{display:inline-flex; align-items:center; gap:8px; margin:6px 6px 0 0}
    .chip button{border:none; background:transparent; color:var(--muted); cursor:pointer}
    .row .remove{border:1px solid rgba(255,0,0,.35); color:#fff; background:rgba(255,0,0,.15);}
    .toolbar{display:flex; gap:10px; justify-content:flex-end; margin-top:10px}
    .btn{border:1px solid var(--glass-border); background:var(--glass); color:var(--fg); border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer}
    .btn.primary{background:linear-gradient(135deg, rgba(230,57,70,.25), rgba(46,196,182,.20))}

    /* Overlay logo animation */
    #overlayLogo{position:fixed; inset:0; display:none; place-items:center; z-index:60}
    #overlayLogo .box{background:rgba(255,255,255,.06); border:1px solid var(--glass-border); padding:16px 22px; border-radius:18px}
    #overlayLogo img{width:140px; animation:zoomInOut 2.6s forwards}
    @keyframes zoomInOut{0%{transform:scale(.6); opacity:0} 50%{transform:scale(1.4); opacity:1} 100%{transform:scale(1); opacity:0}}

    footer{color:var(--muted); text-align:center; padding:24px 18px 40px; font-size:14px}
  </style>
</head>
<body>
  <div class="bg-blob" aria-hidden="true"></div>

  <header>
    <div class="head-inner">
      <a class="brand" href="#" aria-label="Accueil Veille sectorielle">
        <img src="https://upload.wikimedia.org/wikipedia/commons/9/98/Logo_Tereos_2016.png" alt="Tereos" />
        <h1>Veille sectorielle ‚Äî Tereos M&A</h1>
      </a>
      <div class="actions">
        <button class="icon-btn" id="refresh-btn" title="Rafra√Æchir" aria-label="Rafra√Æchir">üîÑ</button>
        <button class="icon-btn" id="config-btn" title="Configurer" aria-label="Configurer">‚öôÔ∏è</button>
      </div>
    </div>
  </header>

  <nav>
    <div class="tabs" id="category-buttons"></div>
  </nav>

  <main>
    <!-- Carousel Derni√®res news -->
    <section class="carousel" aria-label="Derni√®res actualit√©s">
      <button class="cbtn prev" aria-label="Pr√©c√©dent">‚óÄ</button>
      <div class="track" id="carousel"><div class="slide">Chargement‚Ä¶</div></div>
      <button class="cbtn next" aria-label="Suivant">‚ñ∂</button>
    </section>

    <!-- Flux par cat√©gorie -->
    <section class="feed" id="rss-feed"><p class="meta">Chargement des actualit√©s‚Ä¶</p></section>
  </main>

  <!-- Configurator Modal -->
  <div class="modal" id="configurator-modal" aria-hidden="true">
    <div class="scrim" role="button" tabindex="0"></div>
    <div class="panel" role="dialog" aria-modal="true" aria-labelledby="cfg-title">
      <h2 id="cfg-title">Configuration des cat√©gories & mots-cl√©s</h2>
      <div id="configurator"></div>
      <div class="toolbar">
        <button class="btn" id="add-cat">+ Ajouter cat√©gorie</button>
        <button class="btn" id="close-cfg">Fermer</button>
        <button class="btn primary" id="apply-cfg">Appliquer</button>
      </div>
    </div>
  </div>

  <!-- Overlay Logo -->
  <div id="overlayLogo"><div class="box"><img src="https://upload.wikimedia.org/wikipedia/commons/9/98/Logo_Tereos_2016.png" alt="Logo Tereos" /></div></div>

  <footer>¬© <span id="year"></span> Tereos ‚Äî Veille sectorielle.</footer>

  <script>
    // ======= Data sources =======
    const makeWebhookURL = "https://hook.eu2.make.com/evvl4g8reogx47pssd32r7gwgcjs83q3"; // optionnel
    const sheetURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQyqGh87x5NiJo54ujJJ9BqMbQTQVKGzk0QpUQDrUV18G1O-EoCscWRo6FOLYLLnu8FcAt5O0ukHJPT/pub?gid=565132429&single=true&output=csv';

    // ======= State =======
    let categoriesData = {}; // {cat: [kw]}
    let allData = []; // {title, link, pubDate, category}
    let currentIndex = 0, totalSlides = 0;

    // ======= Helpers UI =======
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const year = new Date().getFullYear(); $('#year').textContent = year;

    function showOverlayLogo(){ const o = $('#overlayLogo'); o.style.display = 'grid'; setTimeout(()=> o.style.display='none', 2600); }

    // ======= Load categories from Google Sheet =======
    async function loadCategoriesFromSheet(){
      try{
        const res = await fetch(sheetURL);
        const csv = await res.text();
        const rows = csv.split('\n').slice(1);
        categoriesData = {};
        for(const line of rows){
          const [category, keyword] = line.split(',').map(x => (x||'').trim());
          if(!category || !keyword) continue;
          (categoriesData[category] ??= []).push(keyword);
        }
        await loadAllFeeds();
      }catch(e){ console.error('Sheet load error', e); }
    }

    // ======= Persist categories to Make (optionnel) =======
    async function saveCategoriesToMake(){
      try{
        for(const [cat,kws] of Object.entries(categoriesData)){
          for(const kw of kws){
            await fetch(makeWebhookURL,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ cat√©gorie:cat, mot_cl√©:kw })});
          }
        }
      }catch(e){ console.warn('Make webhook skipped/failed', e); }
    }

    // ======= Build Google News RSS URLs =======
    function getRSSUrls(){
      const urls = {};
      for(const [cat,kws] of Object.entries(categoriesData)){
        urls[cat] = kws.map(kw => `https://news.google.com/rss/search?q=${encodeURIComponent('"'+kw+'"')}&hl=fr&gl=FR&ceid=FR:fr`);
      }
      return urls;
    }

    // ======= Fetch & parse one RSS (via rss2json) =======
    async function fetchRSS(url, category){
      try{
        const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`);
        const data = await res.json();
        if(!data.items) return [];
        return data.items.map(i => ({ title:i.title, link:i.link, pubDate:i.pubDate, category }));
      }catch{ return []; }
    }

    // ======= Load all feeds =======
    async function loadAllFeeds(){
      allData = [];
      const urls = getRSSUrls();
      for(const [cat,links] of Object.entries(urls)){
        for(const link of links){
          const items = await fetchRSS(link, cat);
          allData.push(...items);
        }
      }
      renderCategories();
      renderCarousel();
      // auto-select first tab
      const first = $('#category-buttons .tab'); if(first) first.click();
    }

    // ======= Render tabs =======
    function renderCategories(){
      const wrap = $('#category-buttons');
      wrap.innerHTML = '';
      for(const cat of Object.keys(categoriesData)){
        const btn = document.createElement('button');
        btn.className = 'tab'; btn.type = 'button'; btn.textContent = cat;
        btn.onclick = () => { $$('.tab', wrap).forEach(b=>b.classList.remove('active')); btn.classList.add('active'); renderFeed(cat); };
        wrap.appendChild(btn);
      }
    }

    // ======= Render feed for a category =======
    function renderFeed(category){
      const container = $('#rss-feed');
      const filtered = allData.filter(i => i.category === category).sort((a,b)=> new Date(b.pubDate)-new Date(a.pubDate));
      if(!filtered.length){ container.innerHTML = '<p class="meta">Aucun article trouv√©.</p>'; return; }
      container.innerHTML = filtered.map(item => `
        <article class="card">
          <h3><a href="${item.link}" target="_blank" rel="noopener">${item.title}</a></h3>
          <div class="meta"><time datetime="${item.pubDate}">${new Date(item.pubDate).toLocaleString()}</time><span>‚Ä¢</span><span>${item.category}</span></div>
        </article>
      `).join('');
    }

    // ======= Carousel (latest 10) =======
    function renderCarousel(){
      const carousel = $('#carousel');
      const latest = [...allData].sort((a,b)=> new Date(b.pubDate)-new Date(a.pubDate)).slice(0,10);
      if(!latest.length){ carousel.innerHTML = '<div class="slide">Aucune actualit√© r√©cente.</div>'; totalSlides=1; currentIndex=0; return; }
      carousel.innerHTML = latest.map(item => `
        <div class="slide">
          <h2><a href="${item.link}" target="_blank" rel="noopener">${item.title}</a></h2>
          <time datetime="${item.pubDate}">${new Date(item.pubDate).toLocaleString()}</time>
          <div class="cat">${item.category}</div>
        </div>
      `).join('');
      totalSlides = latest.length; currentIndex = 0; updateCarousel();
    }
    function updateCarousel(){ $('#carousel').style.transform = `translateX(-${currentIndex*100}%)`; }
    function nextSlide(){ if(!totalSlides) return; currentIndex = (currentIndex+1)%totalSlides; updateCarousel(); }
    function prevSlide(){ if(!totalSlides) return; currentIndex = (currentIndex-1+totalSlides)%totalSlides; updateCarousel(); }

    // ======= Configurator =======
    function openConfigurator(){ const m=$('#configurator-modal'); m.classList.add('open'); m.setAttribute('aria-hidden','false'); renderConfigurator(); }
    function closeConfigurator(){ const m=$('#configurator-modal'); m.classList.remove('open'); m.setAttribute('aria-hidden','true'); }

    function renderConfigurator(){
      const box = $('#configurator'); box.innerHTML='';
      for(const [cat,kws] of Object.entries(categoriesData)){
        box.appendChild(makeCategoryBlock(cat, kws));
      }
    }

    function makeCategoryBlock(catName, keywords){
      const block = document.createElement('div'); block.className='cblock';
      block.innerHTML = `
        <div class="row">
          <input class="input cname" value="${catName}" placeholder="Nom de la cat√©gorie" />
          <button class="btn remove">Supprimer</button>
        </div>
        <div class="kw"></div>
        <div class="row"><button class="btn addkw">+ Ajouter mot-cl√©</button></div>
      `;
      const kwBox = $('.kw', block);
      for(const kw of keywords){ kwBox.appendChild(makeKeywordChip(kw)); }
      $('.addkw', block).onclick = ()=> kwBox.appendChild(makeKeywordChip(''));
      $('.remove', block).onclick = ()=> block.remove();
      return block;
    }

    function makeKeywordChip(value){
      const chip = document.createElement('span'); chip.className='chip';
      chip.innerHTML = `<input class="input kwin" value="${value}" placeholder="Mot-cl√©" /> <button title="Supprimer">‚úï</button>`;
      chip.querySelector('button').onclick = ()=> chip.remove();
      return chip;
    }

    function collectConfig(){
      const result = {};
      $$('#configurator .cblock').forEach(block=>{
        const name = $('.cname', block).value.trim();
        const kws = $$('.kwin', block).map(i=> i.value.trim()).filter(Boolean);
        if(name && kws.length) result[name]=kws;
      });
      return result;
    }

    async function applyConfig(){
      categoriesData = collectConfig();
      showOverlayLogo();
      closeConfigurator();
      await saveCategoriesToMake();
      await loadAllFeeds();
    }

    function addCategoryBlock(){ $('#configurator').appendChild(makeCategoryBlock('Nouvelle cat√©gorie', [])); }

    // ======= Events =======
    $('#refresh-btn').onclick = loadCategoriesFromSheet;
    $('#config-btn').onclick = openConfigurator;
    $('#add-cat').onclick = addCategoryBlock;
    $('#close-cfg').onclick = closeConfigurator;
    $('#apply-cfg').onclick = applyConfig;
    $('.scrim').onclick = closeConfigurator;

    $('.prev').onclick = prevSlide; $('.next').onclick = nextSlide;

    // Keyboard accessibility
    document.addEventListener('keydown', (e)=>{
      if(e.key==='ArrowLeft') prevSlide();
      if(e.key==='ArrowRight') nextSlide();
      if(e.key==='Escape') closeConfigurator();
    });

    // ======= Init =======
    window.onload = loadCategoriesFromSheet;
  </script>
</body>
</html>
